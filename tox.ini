[tox]
requires =
    tox>=4.2
env_list =
    py{310,311,312,313}-{core,opencv,albumentations,pillow,waterdroplet,skimage,diffusion,pybsm,doctests}
    ; py{310,311,312,313}-{maite}

    ; TEMP: Replaces pytest-core until new import guard style is fully implemented
    py{310,311,312,313}-unmarked
    ; TEMP: Replaces pytest-extras until new import guard style is fully implemented
    py{310,311,312,313}-unmarked-all

[testenv]
description = Run tests with pytest
skip_install = true
set_env =
    CUDA_VISIBLE_DEVICES =
    COVERAGE_FILE = .coverage.{envname}
    PYTEST_ARGS = -n auto --junit-xml=".junit.{envname}.xml" -rfE --tb=short -q --no-header --disable-warnings
dependency_groups =
    tests
deps =
    ; TEMP: Replaces pytest-core until new import guard style is fully implemented
    unmarked-!all: -e .
    ; TEMP: Replaces pytest-extras until new import guard style is fully implemented
    unmarked-all: -e .[maite]

    core: -e .
    pybsm: -e .[pybsm]
    pillow: -e .[pillow]
    opencv: -e .[headless]
    skimage: -e .[skimage]
    waterdroplet: -e .[waterdroplet]
    albumentations: -e .[albumentations,headless]
    diffusion: -e .[diffusion]
    ; maite: -e .[pybsm,pillow,skimage,headless,waterdroplet,albumentations,diffusion,maite]

    ; all extras environments
    doctests: -e .[pybsm,pillow,skimage,headless,waterdroplet,albumentations,diffusion,maite]
commands =
    ; TEMP: Replaces pytest-core until new import guard style is fully implemented
    unmarked: pytest {env:PYTEST_ARGS} -k "not _public_imports" -m "not opencv and not albumentations and not core and not notebooks and not pillow and not waterdroplet and not skimage and not diffusion and not pybsm"
    ; TEMP: Replaces pytest-extras until new import guard style is fully implemented
    unmarked-all: pytest {env:PYTEST_ARGS} -k "not _public_imports" -m "not opencv and not albumentations and not core and not notebooks and not pillow and not waterdroplet and not skimage and not diffusion and not pybsm"

    core: pytest {env:PYTEST_ARGS} -m "core"
    pillow: pytest {env:PYTEST_ARGS} -m "pillow"
    opencv: pytest {env:PYTEST_ARGS} -m "opencv and not albumentations"
    skimage: pytest {env:PYTEST_ARGS} -m "skimage"
    albumentations: pytest {env:PYTEST_ARGS} -m "albumentations and opencv"
    diffusion: pytest {env:PYTEST_ARGS} -m "diffusion"
    ; maite: pytest {env:PYTEST_ARGS} -m "maite"

    ; Uses numba (jit) compiler for parallelization, -n0 overrides -n auto.
    pybsm: pytest {env:PYTEST_ARGS} -n0 -m "pybsm"
    waterdroplet: pytest {env:PYTEST_ARGS} -n0 -m "waterdroplet"

    ; Doctests require that all extras be installed, so this is the only time we run doctests
    doctests: pytest {env:PYTEST_ARGS} src/nrtk --doctest-modules

; Pyright tests on notebooks (tests/examples/test_notebooks.py::test_pyright_nb)
; Split into its own section to isolate the many version pins needed for pyright type resolution.
[testenv:py{310,311,312,313}-notebooks]
deps =
    -e .[pybsm,pillow,skimage,headless,waterdroplet,albumentations,diffusion,maite]
    ; Pin pyright to match poetry.lock (0d0e29f9) - newer versions have stricter type checking
    pyright[nodejs]==1.1.397
    jupytext>=1.16.7
    ; Packages below are required for pyright type resolution in notebooks
    torchmetrics>=1.0.0
    ; Pin ultralytics to 8.3.85 - newer versions have broken type stubs for YOLO export
    ultralytics==8.3.85
    ; Pin numpy<2 to match ultralytics 8.3.85 requirements (pip doesn't resolve this automatically)
    ; For Python 3.13, numpy 2.x is required (no 1.26.x wheels available)
    py{310,311,312}: numpy>=1.26.4,<2
    py313: numpy>=2.1
    ; Pin pandas>=2.2.3 for Python 3.13 wheel support (2.2.2 has no py313 wheels)
    pandas>=2.2.3
    ; Pin torch/torchmetrics to match poetry.lock (0d0e29f9) - newer versions have incompatible type annotations
    torch==2.8.0
    ; Pin datasets to match poetry.lock (0d0e29f9) - required for pyright type resolution in jatic-perturbations-saliency
    datasets==4.0.0
commands =
    pytest {env:PYTEST_ARGS} -m "notebooks"

; Standalone env so it won't run with `tox` or `tox -f py310`.
; Run explicitly with: tox -e papermill -- <notebook> <output>
[testenv:papermill]
description = Run notebooks via papermill
base_python = py310
skip_install = true
deps =
    -e .[pybsm,pillow,skimage,headless,waterdroplet,albumentations,diffusion,maite]
    papermill>=2.4.0
    notebook>=7.2.2
commands =
    papermill --progress-bar --stdout-file - --stderr-file - {posargs}
