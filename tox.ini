[tox]
requires =
    tox>=4.2
env_list =
    py{310,311,312,313}-{core,opencv,albumentations,pillow,waterdroplet,skimage,diffusion,pybsm,maite,tools,doctests}
[testenv]
description = Run tests with pytest
skip_install = true
set_env =
    CUDA_VISIBLE_DEVICES =
    COVERAGE_FILE = .coverage.{envname}
    PYTEST_ARGS = -n auto --junit-xml=".junit.{envname}.xml" -rfE --tb=short -q --no-header --disable-warnings
dependency_groups =
    tests
deps =
    core: -e .
    pybsm: -e .[pybsm]
    pillow: -e .[pillow]
    opencv: -e .[headless]
    skimage: -e .[skimage]
    waterdroplet: -e .[waterdroplet]
    albumentations: -e .[albumentations,headless]
    diffusion: -e .[diffusion]
    maite: -e .[maite]
    tools: -e .[maite,tools]

    ; all extras environments
    doctests: -e .[pybsm,pillow,skimage,headless,waterdroplet,albumentations,diffusion,maite,tools]
commands =
    core: pytest {env:PYTEST_ARGS} -m "core"
    pillow: pytest {env:PYTEST_ARGS} -m "pillow"
    opencv: pytest {env:PYTEST_ARGS} -m "opencv and not albumentations"
    skimage: pytest {env:PYTEST_ARGS} -m "skimage"
    albumentations: pytest {env:PYTEST_ARGS} -m "albumentations and opencv"
    diffusion: pytest {env:PYTEST_ARGS} -m "diffusion"
    maite: pytest {env:PYTEST_ARGS} -m "maite and not tools"
    tools: pytest {env:PYTEST_ARGS} -m "maite and tools"

    ; Uses numba (jit) compiler for parallelization, -n0 overrides -n auto.
    pybsm: pytest {env:PYTEST_ARGS} -n0 -m "pybsm"
    waterdroplet: pytest {env:PYTEST_ARGS} -n0 -m "waterdroplet"

    ; Doctests require that all extras be installed, so this is the only time we run doctests
    doctests: pytest {env:PYTEST_ARGS} src/nrtk --doctest-modules

; Pyright tests on notebooks (tests/examples/test_notebooks.py::test_pyright_nb)
; Split into its own section to isolate the many version pins needed for pyright type resolution.
; These deps are intentionally kept here (not in pyproject.toml) to avoid resolution
; conflicts with the rest of the project — the tight pins (torch, ultralytics, numpy, etc.)
; are difficult for Poetry to resolve alongside other dependency groups.
[testenv:py{310,311,312,313}-notebooks]
deps =
    -e .[pybsm,pillow,skimage,headless,waterdroplet,albumentations,diffusion,maite]
    ; Pin pyright to match poetry.lock (0d0e29f9) - newer versions have stricter type checking
    pyright[nodejs]==1.1.397
    jupytext>=1.16.7
    ; Packages below are required for pyright type resolution in notebooks
    torchmetrics>=1.0.0
    ; Pin ultralytics to 8.3.85 - newer versions have broken type stubs for YOLO export
    ultralytics==8.3.85
    ; Pin numpy<2 to match ultralytics 8.3.85 requirements (pip doesn't resolve this automatically)
    ; For Python 3.13, numpy 2.x is required (no 1.26.x wheels available)
    py{310,311,312}: numpy>=1.26.4,<2
    py313: numpy>=2.1
    ; Pin pandas>=2.2.3 for Python 3.13 wheel support (2.2.2 has no py313 wheels)
    pandas>=2.2.3
    ; Pin torch/torchmetrics to match poetry.lock (0d0e29f9) - newer versions have incompatible type annotations
    torch==2.8.0
    ; Pin datasets to match poetry.lock (0d0e29f9) - required for pyright type resolution in jatic-perturbations-saliency
    datasets==4.0.0
commands =
    pytest {env:PYTEST_ARGS} -m "notebooks"

; Standalone env so it won't run with `tox` or `tox -f py310`.
; Run explicitly with: tox -e coverage
; Combines .coverage.* files, generates XML, and enforces the 90% threshold
; (JATIC SDP requirement).
; coverage[toml] is kept here (not in pyproject.toml) because this is a standalone
; CI utility env — no other env or developer workflow needs it as a direct dependency.
[testenv:coverage]
description = Combine coverage reports and enforce threshold
base_python = py310
skip_install = true
set_env =
    COVERAGE_FILE = .coverage
dependency_groups =
deps =
    coverage[toml]>=6.5.0
commands =
    coverage combine --keep
    coverage xml
    coverage report --precision=2 --fail-under=90 --skip-covered --show-missing

; Standalone env so it won't run with `tox` or `tox -f py310`.
; Run explicitly with: tox -e papermill -- <notebook> <output>
; papermill and notebook are kept here (not in pyproject.toml) because this is a
; standalone CI utility env — no other env or developer workflow needs them.
[testenv:papermill]
description = Run notebooks via papermill (builds local wheel so notebooks install nrtk as if from PyPI)
base_python = py313
skip_install = true
set_env =
    CUDA_VISIBLE_DEVICES = {env:CUDA_VISIBLE_DEVICES:}
    # Disable tqdm progress bars to prevent cluttering rendered notebook output
    TQDM_DISABLE = 1
deps =
    build
    nbstripout>=0.6.0
    papermill>=2.4.0
    notebook>=7.2.2
commands_pre =
    python -m build --wheel --outdir {envtmpdir}/dist
    python -m pip install --no-deps --no-cache-dir --no-index --find-links {envtmpdir}/dist nrtk
commands =
    papermill --progress-bar --stdout-file - --stderr-file - {posargs}
    nbstripout --keep-output --keep-count {posargs}
