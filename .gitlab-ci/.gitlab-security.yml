###############################################################################
# Stage -- Security Scanning
###############################################################################

# These includes are pulling from public template files directly embedded in the gitlab source code.
# https://gitlab.com/gitlab-org/gitlab/-/tree/master/lib/gitlab/ci/templates
include:
- template: Jobs/SAST.latest.gitlab-ci.yml
- template: Jobs/Dependency-Scanning.latest.gitlab-ci.yml
- template: Jobs/Secret-Detection.latest.gitlab-ci.yml

sast:
  stage: security
  needs: [pytest] # if unit tests don't pass, don't run
  dependencies: []

dependency_scanning:
  stage: security
  needs:
    - job: build:cache # pulls in cached dependencies for scanning
      artifacts: false
    - job: pytest  # if unit tests don't pass, don't run
      artifacts: false
  before_script:
    - !reference [.shared-setup, before_script]
    - poetry install --sync --with dev-linting,dev-testing,dev-docs
  cache:
    key: $CI_COMMIT_REF_SLUG
    paths:
    - .cache
    policy: pull

secret_detection:
  stage: security
  needs: [pytest] # if unit tests don't pass, don't run
  dependencies: []